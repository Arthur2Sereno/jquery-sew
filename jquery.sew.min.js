(function(e,t,n){function u(t,n){this.element=t,this.$element=e(t),this.$itemList=e(u.MENU_TEMPLATE),this.options=e.extend({},o,n),this.reset(),this._defaults=o,this._name=i,this.expression=new RegExp("(?:^|\\b|\\s)"+this.options.token+"([\\w.]*)$"),this.cleanupHandle=null,this.init()}var r=function(e,t){e.text(t.val)},i="sew",s=t.document,o={token:"@",elementFactory:r,values:[]};u.MENU_TEMPLATE="<div class='-sew-list-container' style='display: none; position: absolute;'><ul class='-sew-list'></ul></div>",u.ITEM_TEMPLATE='<li class="-sew-list-item"></li>',u.KEYS=[40,38,13,27,9],u.prototype.init=function(){if(this.options.values.length<1)return;this.$element.bind("keyup",this.onKeyUp.bind(this)).bind("keydown",this.onKeyDown.bind(this)).bind("focus",this.renderElements.bind(this,this.options.values)).bind("blur",this.remove.bind(this))},u.prototype.reset=function(){this.index=0,this.matched=!1,this.dontFilter=!1,this.lastFilter=n,this.filtered=this.options.values.slice(0)},u.prototype.next=function(){this.index=(this.index+1)%this.filtered.length,this.hightlightItem()},u.prototype.prev=function(){this.index=(this.index+this.filtered.length-1)%this.filtered.length,this.hightlightItem()},u.prototype.select=function(){this.replace(this.filtered[this.index].val),this.hideList()},u.prototype.remove=function(){this.$itemList.fadeOut("slow"),this.cleanupHandle=t.setTimeout(function(){this.$itemList.remove()}.bind(this),1e3)},u.prototype.replace=function(e){var t=this.getSelectionStart(),n=this.$element.val(),r=n.substring(0,t);r=r.replace(this.expression," "+this.options.token+e);var i=r+" "+n.substring(t,n.length);this.$element.val(i),this.setCursorPosition(r.length+1)},u.prototype.hightlightItem=function(){this.$itemList.find(".-sew-list-item").removeClass("selected");var e=this.$itemList.find(".-sew-list-item").parent(),t=this.filtered[this.index].element.addClass("selected"),n=t.position().top;e.scrollTop(e.scrollTop()+n)},u.prototype.renderElements=function(t){e("body").append(this.$itemList);var n=this.$itemList.find("ul").empty();t.forEach(function(t,r){var i=e(u.ITEM_TEMPLATE);this.options.elementFactory(i,t),t.element=i.appendTo(n).bind("click",this.onItemClick.bind(this,t)).bind("mouseover",this.onItemHover.bind(this,r))}.bind(this)),this.index=0,this.hightlightItem()},u.prototype.displayList=function(){if(!this.filtered.length)return;this.$itemList.show();var e=this.$element,t=this.$element.offset(),n=e.getCaretPosition();this.$itemList.css({left:t.left+n.left,top:t.top+n.top})},u.prototype.hideList=function(){this.$itemList.hide(),this.reset()},u.prototype.filterList=function(e){if(e==this.lastFilter)return;this.lastFilter=e,this.$itemList.find(".-sew-list-item").remove();var t=this.filtered=this.options.values.filter(function(t){return e===""||t.val.toLowerCase().indexOf(e.toLowerCase())>=0||(t.meta||"").toLowerCase().indexOf(e.toLowerCase())>=0});t.length?(this.renderElements(t),this.$itemList.show()):this.hideList()},u.prototype.getSelectionStart=function(){input=this.$element[0];var e=input.value.length;if(typeof input.selectionStart!="undefined")e=input.selectionStart;else if(input.createTextRange){var t=s.selection.createRange().duplicate();t.moveEnd("character",input.value.length),t.text===""&&(e=input.value.length),e=input.value.lastIndexOf(t.text)}return e},u.prototype.setCursorPosition=function(e){if(this.$element.get(0).setSelectionRange)this.$element.get(0).setSelectionRange(e,e);else if(this.$element.get(0).createTextRange){var t=this.$element.get(0).createTextRange();t.collapse(!0),t.moveEnd("character",e),t.moveStart("character",e),t.select()}},u.prototype.onKeyUp=function(e){var t=this.getSelectionStart(),n=this.$element.val().substring(0,t),r=n.match(this.expression);if(!r&&this.matched){this.matched=!1,this.dontFilter=!1,this.hideList();return}r&&!this.matched&&(this.displayList(),this.lastFilter="\n",this.matched=!0),r&&!this.dontFilter&&this.filterList(r[1])},u.prototype.onKeyDown=function(e){var t=this.$itemList.is(":visible");if(!t||u.KEYS.indexOf(e.keyCode)<0)return;switch(e.keyCode){case 9:case 13:this.select();break;case 40:this.next();break;case 38:this.prev();break;case 27:this.$itemList.hide(),this.dontFilter=!0}e.preventDefault()},u.prototype.onItemClick=function(e,n){this.cleanupHandle&&t.clearTimeout(this.cleanupHandle),this.replace(e.val),this.hideList()},u.prototype.onItemHover=function(e,t){this.index=e,this.hightlightItem()},e.fn[i]=function(t){return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new u(this,t))})}})(jQuery,window);